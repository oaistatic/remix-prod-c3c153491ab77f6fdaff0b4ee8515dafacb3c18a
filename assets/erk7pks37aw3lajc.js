import{r as t,e as B,j as d}from"./fs6h2trisr1juto6.js";import{R as k,as as _,dy as T,c5 as D,d as W,c7 as F,P as j,a as N,S as U,cD as L,d6 as P}from"./njq6ygky3ttysgdk.js";import{u as A}from"./opwx9lpj3cdeq66k.js";import{cv as I,cw as G,gU as O}from"./d7a6rc8fexfzu7dt.js";class V{static async transcribe(r,e){const a=new FormData;return a.append("file",r),e&&a.append("language",e),k.post(`${_}/transcribe`,a)}}const q=48e3,z=10,C=q*z,H=4e3,X=10*60*1e3,m=o=>A.setState(r=>{r.status=o}),Z=o=>{const r=t.useRef(o);r.current=o;const e=t.useRef(null),a=t.useRef([]),w=t.useRef(null),v=t.useRef(null),i=t.useRef(null),s=t.useRef(new Float32Array(0)),f=t.useRef(null),n=t.useCallback(()=>{s.current=new Float32Array,r.current.onWaveformDataUpdate(void 0)},[]),c=t.useCallback(async u=>{m("transcribing");try{const h=await V.transcribe(new File([u],"whisper.mp3",{type:"audio/mpeg-3"}));m("idle"),r.current.onSuccess(h.text),n()}catch{m("error"),n()}},[n]),p=t.useCallback(u=>{f.current!==null&&(clearTimeout(f.current),f.current=null),u&&e.current&&(e.current.ondataavailable=null,e.current.onstop=null,m("idle"),n()),e.current?.stop(),e.current?.stream.getTracks().forEach(h=>h.stop()),e.current=null,i.current?.disconnect(),i.current=null,v.current?.disconnect(),v.current=null,w.current?.close(),w.current=null},[n]),y=t.useCallback(()=>{n(),m("recording"),navigator.mediaDevices.getUserMedia({audio:{sampleRate:H,channelCount:1}}).then(u=>{e.current=new MediaRecorder(u),T()?(a.current=[],e.current.ondataavailable=l=>{l.data.size>0&&a.current.push(l.data)},e.current.onstop=async()=>{const l=new Blob(a.current,{type:"audio/mpeg-3"});await c(l)},e.current.start(1e3)):(e.current.ondataavailable=async l=>{await c(l.data)},e.current.start()),s.current=new Float32Array(C).fill(r.current.initialValue),r.current.onWaveformDataUpdate(s.current),m("recording"),f.current=window.setTimeout(()=>{p()},X);const R=new AudioContext;w.current=R;const g=R.createMediaStreamSource(u);v.current=g;const E=R.createScriptProcessor(2048,1,1);i.current=E,E.onaudioprocess=l=>{const x=l.inputBuffer.getChannelData(0);for(let b=0;b<x.length;b++)x[b]=Math.max(x[b],r.current.initialValue);const M=s.current,S=new Float32Array(M.length+x.length);if(S.set(M,0),S.set(x,M.length),S.length>C){const b=S.length-C;s.current=S.slice(b)}else s.current=S;r.current.onWaveformDataUpdate(s.current)},g.connect(E),E.connect(R.destination)}).catch(()=>{m("error"),n()})},[n,p,c]);return t.useEffect(()=>()=>{p(!0)},[p]),{startRecording:y,stopRecording:p}};function Y({disabled:o=!1,size:r="small",initialValue:e,onSuccess:a,onWaveformDataUpdate:w,onExit:v}){const i=B(),s=A(g=>g.status),f=t.useRef(!1),{startRecording:n,stopRecording:c}=Z({onSuccess:a,onWaveformDataUpdate:w,initialValue:e});t.useEffect(()=>{const g=()=>{document.hidden&&c()};return window.addEventListener("visibilitychange",g),()=>{window.removeEventListener("visibilitychange",g),c()}},[c]),t.useEffect(()=>{f.current||(n(),f.current=!0)},[n]);const p=d.jsx("div",{children:d.jsx(D,{"aria-label":i.formatMessage({id:"RMraLB",defaultMessage:"Stop dictation"}),size:r,type:"button",onClick:()=>{c(!0),v()},disabled:o||s==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},className:W(I,o?"opacity-30":G),children:d.jsx(F,{"aria-label":i.formatMessage({id:"DFGZS4",defaultMessage:"Stop dictation"}),className:"h-[18px] w-[18px] text-black dark:text-white",fontSize:"inherit"})})}),y=s==="transcribing",u=y?d.jsx(L,{}):d.jsx(P,{className:"icon-lg"}),h=y?i.formatMessage({id:"CyAAys",defaultMessage:"Transcribing dictation"}):i.formatMessage({id:"fcPx42",defaultMessage:"Submit dictation"}),R=d.jsx("div",{children:d.jsx("button",{type:"button","aria-label":h,className:O,onClick:()=>{j.logEvent(N.composerWhisperButtonClickedEnd),U.logEvent("chatgpt_composer_whisper_button_clicked_end"),c()},children:u})});return d.jsxs("div",{className:"flex gap-x-1.5",children:[p,R]})}export{Y as WhisperModeControls};
//# sourceMappingURL=erk7pks37aw3lajc.js.map
