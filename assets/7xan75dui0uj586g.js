const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/k2iylpnfqz5ejvm7.js","assets/fs6h2trisr1juto6.js","assets/d7a6rc8fexfzu7dt.js","assets/njq6ygky3ttysgdk.js","assets/root-cl538jor.css","assets/conversation-small-m9kq0y4e.css","assets/en8ogvlmn3lccz09.js"])))=>i.map(i=>d[i]);
import{R as j,bQ as q,bR as F,aP as k,y as x,z as I,M as v,V as W,l as B,fC as L,d as C,c5 as P,P as N,a as E,aT as R,aV as T,Z as G,cG as Q}from"./njq6ygky3ttysgdk.js";import{r as y,b as U,u as D,j as o,e as z,M as d,c as K}from"./fs6h2trisr1juto6.js";import{ej as Y,U as V,Z,ek as X}from"./d7a6rc8fexfzu7dt.js";import{S as $}from"./hyj1ewu0eyfbsrce.js";const b="memories/current_memory_undo_id",A={async getCurrentMemoryUndoId(e){return await j.safeGet("/memories/current_memory_undo_id",{parameters:{query:{gizmo_id:e}}})},async undoMemoryWrite(e,t){return await j.safePost("/memories/undo_memory_write",{requestBody:{gizmo_id:e,memory_undo_id:t}})}},H=q(()=>F(()=>import("./k2iylpnfqz5ejvm7.js").then(e=>e.b),__vite__mapDeps([0,1,2,3,4,5,6])));function O(e){return e.find(t=>t.author.role===x.Tool&&t.metadata?.pending_memory_info)}function J(e){return e.filter((t,n)=>{const r=e[n+1],i=r?.recipient==="assistant"&&r?.author.role===x.Tool&&r?.author.name==="bio"&&I(r).startsWith("Model set context");return t.author.role===x.Assistant&&t.recipient==="bio"&&i}).flatMap(t=>{const n=t.content.content_type;return n===v.Text?t.content.parts:n===v.Code?[t.content.text]:[]}).map(le)}function ee(e){return e.some(t=>t.author.role===x.Assistant&&t.recipient==="bio"&&t.status==="in_progress")}function te(e){return e.find(n=>n.author.role===x.Tool&&n.author.name==="bio"&&n.recipient===x.Assistant)?.metadata?.current_memory_undo_id}function oe(e){const{eligible:t,isLoading:n}=Y(),r=y.useMemo(()=>e.length>0,[e]);y.useEffect(()=>{r&&t&&!n&&V.openModal(Z.GlobalMemoryOnboarding)},[r,t,n])}function ne(e){const[t,n]=y.useState(!1);return{isPopoverOpen:t,setIsPopoverOpen:n,handleTogglePopover:s=>{const i=s??!t;n(i),i&&N.logEvent(E.memoryUpdatePopoverShown,{updateCount:e.length})}}}function w({memoryWrites:e,popoverState:t,triggerButton:n,isParagen:r,gizmoId:s,memoryUndoId:i,setShowMemoriesModal:l}){return o.jsxs(X,{open:t.isPopoverOpen,sideOffset:4,side:"bottom",alignAgainstAnchor:"start",size:"none",className:"z-10 min-w-60 max-w-96 text-sm",onOpenChange:a=>t.handleTogglePopover(a),disableAutofocus:!0,triggerButton:n,children:[o.jsx("div",{className:"mb-2 rounded border border-token-border-light bg-token-main-surface-secondary",children:e.map((a,u)=>o.jsx("div",{className:"border-b border-token-border-light px-3 py-2 first-letter:uppercase last:border-b-0",children:a},u))}),r?o.jsx("div",{className:"text-xs text-token-text-tertiary",children:o.jsx(d,{id:"MemoryActionResult.paragenMessage",defaultMessage:"This memory will be saved if you choose this response."})}):o.jsxs(o.Fragment,{children:[o.jsx(ae,{gizmoId:s,memoryUndoId:i}),o.jsx(S,{onClick:()=>{l(!0),N.logEvent(E.memoryUpdatePopoverManageButtonClicked,{updateCount:e.length})},children:o.jsx(d,{id:"MemoryActionResult.manageMemories",defaultMessage:"Manage memories"})})]})]})}function re({clientThreadId:e,pendingMessage:t,memoryWrites:n,popoverState:r,setShowMemoriesModal:s}){const i=W(),l=z(),a=B(e),u=L({clientThreadId:e}),M=n.join(" ");let p=M.slice(0,50).replace(new RegExp("^\\p{L}","u"),m=>m.toLocaleUpperCase()).replace(/\.$/,"");M.length>50&&(p+="...");const f=async m=>{if(!a)throw new Error("Failed to confirm or reject memory update: serverThreadId is not found");const g=t.metadata?.pending_memory_info;R(e,h=>{T.updateTree(h,c=>{c.updateNodeMessageMetadata(t.id,{pending_memory_info:{...g,is_pending:!1,confirm_result:m}})})});try{await G.confirmOrRejectMemory(t.id,a,m)}catch{i.danger(l.formatMessage({id:"memory.confirmOrDenyFail",defaultMessage:"Failed to confirm or reject memory update"})),R(e,c=>{T.updateTree(c,_=>{_.updateNodeMessageMetadata(t.id,{pending_memory_info:g})})})}};return o.jsxs("div",{className:"flex items-start",children:[o.jsx("div",{className:"inline-block text-sm font-semibold text-token-text-tertiary outline-none",children:o.jsx(d,{id:"MemoryActionResult.memoryConfirmation",defaultMessage:"Update memory? {memoryText}",values:{memoryText:o.jsx("div",{className:"inline-block py-1",onMouseOver:()=>r.handleTogglePopover(!0),onMouseOut:()=>r.handleTogglePopover(!1),children:o.jsx(w,{memoryWrites:n,popoverState:r,triggerButton:o.jsx("button",{className:C("text-left font-normal",r.isPopoverOpen?"text-token-text-secondary":"text-token-text-tertiary"),children:o.jsx(d,{id:"MemoryActionResult.memoryWrapper",defaultMessage:"“{memoryWrites}”",values:{memoryWrites:p}})}),setShowMemoriesModal:s})})}})}),o.jsx(P,{className:"ml-3 text-token-text-tertiary hover:text-token-text-primary",size:"xs",color:"secondary",disabled:u,onClick:()=>{f(!0)},children:o.jsx(d,{id:"MemoryActionResult.confirm",defaultMessage:"Yes"})}),o.jsx(P,{className:"ml-2 text-token-text-tertiary hover:text-token-text-primary",size:"xs",color:"secondary",disabled:u,onClick:()=>{f(!1)},children:o.jsx(d,{id:"MemoryActionResult.deny",defaultMessage:"No"})})]})}function se({memoryWrites:e,popoverState:t,isParagen:n,memoryUndoId:r,gizmoId:s,setShowMemoriesModal:i}){return e.length===0?null:o.jsx(o.Fragment,{children:o.jsx("div",{className:"inline-block",onMouseOver:()=>t.handleTogglePopover(!0),onMouseOut:()=>t.handleTogglePopover(!1),children:o.jsx(w,{memoryWrites:e,popoverState:t,isParagen:n,gizmoId:s,memoryUndoId:r,triggerButton:o.jsxs("button",{className:C("my-1 flex items-center gap-1 text-sm font-semibold outline-none",t.isPopoverOpen?"text-token-text-secondary":"text-token-text-tertiary"),children:[o.jsx($,{className:"mb-[-1px]"}),e.length===1?o.jsx(d,{id:"MemoryActionResult.memoryWriteSingular.1",defaultMessage:"Memory updated"}):o.jsx(d,{id:"MemoryActionResult.memoryWritePlural.1",defaultMessage:"Memories updated"})]}),setShowMemoriesModal:i})})})}function ie(e){const t=O(e),n=t?.metadata?.pending_memory_info?.confirm_result;return t==null?null:n===!0?"confirmed":n===!1?"denied":"pending"}function fe({messages:e,clientThreadId:t,gizmoId:n,isParagen:r}){const s=J(e),i=ne(s),l=ee(e),a=te(e);oe(s);const u=O(e),{config:M}=k("3983984123"),p=M.get("is_memory_undo_enabled",!1),f=y.useRef(!1),m=U();y.useEffect(()=>{l&&f.current===!1&&(f.current=!0),!l&&!u&&a&&f.current&&m.invalidateQueries({queryKey:[b,n]})},[l,u,a,n,m]);const{data:g}=D({queryKey:[b,n],queryFn:()=>A.getCurrentMemoryUndoId(n),enabled:p&&!l&&!u}),[h,c]=y.useState(!1),_=ie(e);return _==="denied"?null:l?o.jsx("div",{className:"result-streaming",children:o.jsx("span",{children:o.jsx("pre",{})})}):o.jsxs(o.Fragment,{children:[_==="pending"?o.jsx(re,{clientThreadId:t,memoryWrites:s,popoverState:i,setShowMemoriesModal:c,pendingMessage:u}):o.jsx(se,{memoryWrites:s,popoverState:i,isParagen:r,memoryUndoId:g?.current_memory_undo_id===a?a:void 0,setShowMemoriesModal:c}),h&&o.jsx(H,{initialGizmoId:n,onClose:()=>c(!1)})]})}function S({children:e,disabled:t,onClick:n}){return o.jsxs("button",{className:"flex w-full items-center justify-between rounded px-3 py-2 font-semibold hover:bg-token-main-surface-secondary",disabled:t,onClick:n,children:[e,o.jsx(Q,{className:"icon-md -mr-1 text-token-text-tertiary"})]})}function ae({gizmoId:e,memoryUndoId:t}){const{config:n}=k("3983984123"),r=n.get("is_memory_undo_enabled",!1),s=U(),{isPending:i,mutate:l}=K({mutationFn:a=>A.undoMemoryWrite(e,a),onSuccess:()=>{s.invalidateQueries({queryKey:[b,e]})}});return!r||!t?null:o.jsx(S,{disabled:i,onClick:()=>{t&&l(t)},children:o.jsx(d,{id:"qeyS8G",defaultMessage:"Undo"})})}function le(e){const t=["The user ","The user's ","User ","User's "];for(const n of t)if(e.startsWith(n))return e.slice(n.length);return e}export{fe as MemoryActionResult};
//# sourceMappingURL=7xan75dui0uj586g.js.map
